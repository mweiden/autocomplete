<!DOCTYPE html>
<html>
<head>
    <title>Autocomplete</title>
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';

        function onSubmit(event) {
            event.preventDefault();
            const form = document.querySelector('form');

            // submit the query to the server
            const formData = new FormData(form);
                
            fetch('/submit-query', {
                method: 'POST',
                body: formData
            })
            .catch(error => console.error('Fetch error:', error));

            // show the query that was submitted
            const query_viewer = document.getElementById('query-viewer');
            query_viewer.innerHTML = `Submitted query: ${event.target.query.value}`;
        }

        function setSuggestions(suggestions) {
            const dataList = document.getElementById('suggestions');
            dataList.innerHTML = '';
            suggestions.forEach((item) => {
                const option = document.createElement('option');
                option.value = item;
                dataList.appendChild(option);
            });
        }

        function onFormChange(value) {
            fetch('/autocomplete', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ query: value }),
            })
            .then(response => response.json())
            .then(suggestions => setSuggestions(suggestions))
            .catch((error) => console.error('Error:', error));
        }

        function refreshTrieGraph() {
            fetch('/trie-graph', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(json => {
                const trieViewer = document.getElementById('trie-viewer');
                trieViewer.textContent = json.data;
                trieViewer.removeAttribute('data-processed');
                mermaid.init(undefined, trieViewer);
                console.log("refreshed the trie viewer!")
            });
        }

        function setup() {
            // autocomplete on form change
            const input = document.querySelector('input[name="query"]');
            input.addEventListener('input', (event) => {
                onFormChange(event.target.value);
            });

            // form submission
            var form = document.querySelector('form');
            form.addEventListener('submit', onSubmit);

            // render trie
            mermaid.initialize({ startOnLoad: false, maxEdges: 5000 });
            refreshTrieGraph();

            // SSE for updating the trie dag graph
            var source = new EventSource("{{ url_for('sse.stream') }}");
            source.addEventListener('content-updates', function(event) {
                refreshTrieGraph();
            }, false);
        }

        window.onload = setup;
    </script>
</head>
<body>
    <h2>Autocomplete</h2>
    <em>Autocompletions, ranked based on most frequently submitted queries</em>
    <br/>
    <br/>
    <form method="post" action="/submit-query">
        <input type="text" name="query" list="suggestions" />
        <datalist id="suggestions"></datalist>
        <input type="submit" value="Submit" />
    </form>
    <p id="query-viewer"></p>
    <p>Visualization of the autocomplete Trie:</p>
    <pre class="mermaid" id="trie-viewer"></pre>
</body>
</html>